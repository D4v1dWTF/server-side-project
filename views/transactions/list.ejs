<% const title = 'Transactions'; const body = `
<div class="page-header">
    <h1>Transactions</h1>
    <a href="/transactions/create" class="btn btn-primary">Add Transaction</a>
    <a href="/summary" class="btn btn-secondary">View Summary</a>
</div>

<form method="GET" action="/transactions" class="filter-form">
    <div class="form-row">
        <div class="form-group">
            <label>Search</label>
            <input type="text" name="search" value="<%= typeof search !== 'undefined' ? search : '' %>" placeholder="Search by description">
        </div>
        <div class="form-group">
            <label>Category</label>
            <select name="category">
                <option value="all">All</option>
                <% if (typeof categories !== 'undefined' && categories) { %>
                <% categories.forEach(cat => { %>
                <option value="<%= cat.name %>" <%= typeof category !== 'undefined' && category === cat.name ? 'selected' : '' %>><%= cat.name %></option>
                <% }) %>
                <% } %>
            </select>
        </div>
        <div class="form-group">
            <label>Type</label>
            <select name="type">
                <option value="all">All</option>
                <option value="deposit" <%= typeof type !== 'undefined' && type === 'deposit' ? 'selected' : '' %>>Deposit</option>
                <option value="withdrawal" <%= typeof type !== 'undefined' && type === 'withdrawal' ? 'selected' : '' %>>Withdrawal</option>
            </select>
        </div>
        <div class="form-group">
            <label>Account</label>
            <select name="accountType">
                <option value="all">All</option>
                <option value="current" <%= typeof accountType !== 'undefined' && accountType === 'current' ? 'selected' : '' %>>Current</option>
                <option value="savings" <%= typeof accountType !== 'undefined' && accountType === 'savings' ? 'selected' : '' %>>Savings</option>
            </select>
        </div>
        <div class="form-group">
            <label>Start Date</label>
            <input type="date" name="startDate" value="<%= typeof startDate !== 'undefined' ? startDate : '' %>">
        </div>
        <div class="form-group">
            <label>End Date</label>
            <input type="date" name="endDate" value="<%= typeof endDate !== 'undefined' ? endDate : '' %>">
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-secondary">Filter</button>
            <a href="/transactions" class="btn btn-secondary">Clear</a>
        </div>
    </div>
</form>

<% if (transactions && transactions.length > 0) { %>
<table class="data-table">
    <thead>
        <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Type</th>
            <th>Account</th>
            <th>Category</th>
            <th>Amount</th>
            <th>Balance After</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <% transactions.forEach(t => { %>
        <tr>
            <td><%= new Date(t.date).toLocaleDateString() %></td>
            <td><%= t.description %></td>
            <td><%= t.type %></td>
            <td><%= t.accountType %></td>
            <td><%= t.category %></td>
            <td class="<%= t.type === 'deposit' ? 'positive' : 'negative' %>">$<%= t.amount.toFixed(2) %></td>
            <td>$<%= t.balanceAfter.toFixed(2) %></td>
            <td>
                <a href="/transactions/<%= t._id %>/edit" class="btn btn-small">Edit</a>
                <form method="POST" action="/transactions/<%= t._id %>/delete" style="display:inline;" onsubmit="return confirm('Delete this transaction?')">
                    <button type="submit" class="btn btn-small btn-danger">Delete</button>
                </form>
            </td>
        </tr>
        <% }) %>
    </tbody>
</table>

<form method="POST" action="/export" class="export-form">
    <h3>Export Transactions</h3>
    <div class="form-row">
        <div class="form-group">
            <label>Range</label>
            <select name="range" required>
                <option value="day">Today</option>
                <option value="month">This Month</option>
                <option value="year">This Year</option>
                <option value="custom">Custom</option>
            </select>
        </div>
        <div class="form-group">
            <label>Start Date</label>
            <input type="date" name="startDate" title="Select start date for custom range">
        </div>
        <div class="form-group">
            <label>End Date</label>
            <input type="date" name="endDate" title="Select end date for custom range">
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-primary">Export to Excel</button>
        </div>
    </div>
</form>
<% } else { %>
<p>No transactions found. <a href="/transactions/create">Create one</a></p>
<% } %>
`; %>
<%- include('../layout') %>
